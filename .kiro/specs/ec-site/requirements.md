# 要件ドキュメント

## 導入

本ドキュメントは、Cloudflare Workers / R2 / Durable Object 上に構築するECサイトの要件を定義する。顧客向け機能（商品閲覧・購買フロー・アカウント管理）と管理者向け機能（商品管理・注文管理・顧客管理）を提供し、Event Sourcing / CQRS / DDD（Onion Architecture）に基づき、TypeScript（Hono + Drizzle）によるバックエンドと Vue3 / Nuxt3 によるフロントエンドで実装する。

Always Valid Domain Model・Immutable・Functional Programming の原則を採用し、Zod v4 によるスキーマ検証を全層で適用する。開発環境は mise で統一し、すべてのインフラは Cloudflare プラットフォームのみで完結させる。

## 実装コンテキスト

- **既存実装:** なし
- **判定根拠:** `.kiro/specs/` ディレクトリが存在しない。プロジェクトルートに TypeScript / Vue / Nuxt のソースファイル（`.ts` / `.vue`）が存在しない。`node_modules` と設定ファイル・スクリプト群のみが確認された。

---

## 要件

---

### 要件 1: 商品一覧・検索・絞り込み

**目的:** 顧客として、商品を効率的に検索・絞り込みできる機能を実現し、目的の商品を素早く発見したい。

#### 受け入れ条件

1.1. 顧客が商品一覧ページをリクエストしたとき、商品カタログAPIは公開済み商品を最大50件/ページでページネーションして返却しなければならない。

1.2. 顧客がキーワードを指定して商品検索をリクエストしたとき、商品カタログAPIは商品名または商品説明にそのキーワードを含む商品のみを返却しなければならない。

1.3. 顧客がカテゴリIDを指定して絞り込みをリクエストしたとき、商品カタログAPIは指定カテゴリに属する商品のみを返却しなければならない。

1.4. 顧客が最小価格と最大価格を指定して絞り込みをリクエストしたとき、商品カタログAPIは販売価格が指定範囲内（両端を含む）の商品のみを返却しなければならない。

1.5. 複数の絞り込み条件（キーワード・カテゴリ・価格帯）が同時に指定された場合、商品カタログAPIはすべての条件を同時に満たす商品のみを返却しなければならない。

1.6. 検索・絞り込み結果が0件の場合、商品カタログAPIは空の商品リストと総件数0を返却しなければならない。

1.7. ページ番号がデータ総件数を超える値で指定された場合、商品カタログAPIは空の商品リストを返却しなければならない。

---

### 要件 2: 商品詳細

**目的:** 顧客として、特定商品の詳細情報を確認できる機能を実現し、購入の意思決定に必要な情報を得たい。

#### 受け入れ条件

2.1. 顧客が商品IDを指定して商品詳細をリクエストしたとき、商品詳細APIは商品名・商品説明・販売価格・在庫状況・画像URL一覧を返却しなければならない。

2.2. 対象商品の在庫数が1以上の場合、商品詳細APIは在庫状況として `IN_STOCK` と現在の在庫数を返却しなければならない。

2.3. 対象商品の在庫数が0の場合、商品詳細APIは在庫状況として `OUT_OF_STOCK` を返却しなければならない。

2.4. 存在しない商品IDが指定された場合、商品詳細APIはHTTP 404を返却しなければならない。

2.5. 非公開状態（論理削除済み）の商品IDが指定された場合、商品詳細APIはHTTP 404を返却しなければならない。

---

### 要件 3: お気に入り・ウィッシュリスト

**目的:** 顧客として、気になる商品をウィッシュリストに保存できる機能を実現し、後日購入を検討できるようにしたい。

#### 受け入れ条件

3.1. 認証済み顧客が商品IDを指定してウィッシュリスト追加をリクエストしたとき、ウィッシュリストサービスはその商品をユーザーのウィッシュリストに登録しなければならない。

3.2. 既にウィッシュリストに登録済みの商品IDを追加しようとした場合、ウィッシュリストサービスはHTTP 409を返却しなければならない。

3.3. 認証済み顧客がウィッシュリスト一覧をリクエストしたとき、ウィッシュリストサービスはそのユーザーが登録した商品の一覧を登録日降順で返却しなければならない。

3.4. 認証済み顧客がウィッシュリストから商品を削除したとき、ウィッシュリストサービスはその商品をウィッシュリストから除去しなければならない。

3.5. 未認証の顧客がウィッシュリストAPIにアクセスした場合、ウィッシュリストサービスはHTTP 401を返却しなければならない。

---

### 要件 4: カート

**目的:** 顧客として、購入する商品をカートで管理できる機能を実現し、複数商品をまとめて購入できるようにしたい。

#### 受け入れ条件

4.1. 顧客が商品IDと数量を指定してカートへの追加をリクエストしたとき、カートサービスはその商品と数量をセッションに紐づくカートに追加しなければならない。

4.2. カートに追加しようとした商品の在庫数が0の場合、カートサービスはHTTP 409を返却しなければならない。

4.3. カートに追加しようとした数量が現在の在庫数を超える場合、カートサービスはHTTP 409と `INSUFFICIENT_STOCK` エラーコードを返却しなければならない。

4.4. 顧客がカート内商品の数量変更をリクエストしたとき、カートサービスはカート内の該当商品数量を指定値に更新しなければならない。

4.5. 顧客がカート内商品の数量を0に変更したとき、カートサービスはその商品をカートから除去しなければならない。

4.6. 顧客がカート内商品の削除をリクエストしたとき、カートサービスはその商品をカートから除去しなければならない。

4.7. 顧客がカート内容をリクエストしたとき、カートサービスはカート内商品一覧・各商品の現在価格・商品小計・カート合計金額を返却しなければならない。

4.8. カート内に登録された商品の価格が変更された場合、カートサービスは合計金額の計算に変更後の最新価格を使用しなければならない。

---

### 要件 5: チェックアウト

**目的:** 顧客として、配送先と配送方法を選択して注文を確定できる機能を実現し、スムーズに購入を完了したい。

#### 受け入れ条件

5.1. 認証済み顧客がチェックアウト開始をリクエストしたとき、チェックアウトサービスはカート内商品一覧・登録済み住所一覧・利用可能な配送方法一覧を返却しなければならない。

5.2. カートが空の状態でチェックアウト開始をリクエストした場合、チェックアウトサービスはHTTP 400と `CART_EMPTY` エラーコードを返却しなければならない。

5.3. 顧客が配送先住所として郵便番号・都道府県・市区町村・番地・氏名・電話番号を送信したとき、チェックアウトサービスはすべての項目が入力されていることを検証しなければならない。

5.4. 必須住所項目が未入力の場合、チェックアウトサービスはHTTP 400と未入力の項目名一覧を返却しなければならない。

5.5. 顧客が配送方法を選択したとき、チェックアウトサービスは選択された配送方法の送料を注文合計金額に加算した確認金額を返却しなければならない。

5.6. チェックアウト処理中にカート内商品の在庫が不足している場合、チェックアウトサービスはHTTP 409と在庫不足の商品名一覧を返却しなければならない。

5.7. 未認証の顧客がチェックアウトAPIにアクセスした場合、チェックアウトサービスはHTTP 401を返却しなければならない。

---

### 要件 6: 決済

**目的:** 顧客として、複数の決済手段を使用して注文を確定できる機能を実現し、好みの支払い方法で購入できるようにしたい。

#### 受け入れ条件

6.1. 顧客がクレジットカード情報と決済金額を送信したとき、決済サービスは外部決済プロバイダーに承認リクエストを送信しその承認結果を返却しなければならない。

6.2. クレジットカード決済が外部プロバイダーに拒否された場合、決済サービスはHTTP 402と `PAYMENT_DECLINED` エラーコードを返却しなければならない。

6.3. 顧客がコンビニ払いを選択して決済を開始したとき、決済サービスは払込票番号と支払い期限（決済開始から72時間後）を返却しなければならない。

6.4. 顧客が代引きを選択したとき、決済サービスは代引き手数料を注文合計金額に加算した最終金額を返却しなければならない。

6.5. 決済が正常に完了したとき、決済サービスは `PaymentCompleted` イベントを発行し在庫数を注文数量分だけ減少させなければならない。

6.6. 同一商品への決済が同時並行で実行された場合、決済サービスは楽観的ロックにより先着の決済のみを確定し後続の決済にはHTTP 409を返却しなければならない。

6.7. 決済サービスは常にクレジットカード番号・CVVをアプリケーションログに記録してはならない。

---

### 要件 7: 注文確認メール

**目的:** 顧客として、注文完了後に確認メールを受け取れる機能を実現し、注文内容を記録として手元に保持できるようにしたい。

#### 受け入れ条件

7.1. 注文が確定したとき、メール送信サービスは注文確定から5分以内に顧客の登録メールアドレス宛に注文確認メールを送信しなければならない。

7.2. 注文確認メールは注文番号・注文日時・商品名と数量の一覧・小計・送料・合計金額・配送先住所を含まなければならない。

7.3. メール送信が失敗した場合、メール送信サービスは30分間隔で最大3回再送信を試みなければならない。

7.4. 3回の再送信後もメール送信が失敗した場合、メール送信サービスは送信失敗レコードをエラーログに記録しなければならない。

---

### 要件 8: 会員登録

**目的:** 顧客として、アカウントを作成できる機能を実現し、購入履歴や住所を管理できるようにしたい。

#### 受け入れ条件

8.1. ユーザーが有効なメールアドレスとパスワードを送信して会員登録をリクエストしたとき、認証サービスはアカウントを作成しメールアドレス確認メールを送信しなければならない。

8.2. 送信されたパスワードが8文字未満の場合、認証サービスはHTTP 400と `PASSWORD_TOO_SHORT` エラーコードを返却しなければならない。

8.3. 既に登録済みのメールアドレスで会員登録をリクエストした場合、認証サービスはHTTP 409と `EMAIL_ALREADY_EXISTS` エラーコードを返却しなければならない。

8.4. 無効な形式のメールアドレスを送信した場合、認証サービスはHTTP 400と `INVALID_EMAIL_FORMAT` エラーコードを返却しなければならない。

---

### 要件 9: ログイン・トークン管理

**目的:** 顧客として、登録したアカウントでログインできる機能を実現し、個人の購入情報にアクセスできるようにしたい。

#### 受け入れ条件

9.1. 登録済みのメールアドレスと正しいパスワードを送信してログインをリクエストしたとき、認証サービスはアクセストークン（有効期限1時間）とリフレッシュトークン（有効期限30日）を返却しなければならない。

9.2. 存在しないメールアドレスまたは誤ったパスワードでログインをリクエストした場合、認証サービスはHTTP 401と `INVALID_CREDENTIALS` エラーコードを返却しなければならない。

9.3. 同一アカウントへのログイン失敗が5回連続で発生した場合、認証サービスは当該アカウントを15分間ロックしその後のログイン試行にHTTP 423を返却しなければならない。

9.4. 有効なリフレッシュトークンを送信してトークン更新をリクエストしたとき、認証サービスは新しいアクセストークン（有効期限1時間）を返却しなければならない。

9.5. 有効期限切れまたは改ざんされたアクセストークンを送信した場合、認証サービスはHTTP 401を返却しなければならない。

---

### 要件 10: パスワードリセット

**目的:** 顧客として、パスワードを忘れた場合に再設定できる機能を実現し、アカウントへのアクセスを回復できるようにしたい。

#### 受け入れ条件

10.1. 顧客がメールアドレスを指定してパスワードリセットをリクエストしたとき、認証サービスは当該アドレスにリセットリンク（有効期限1時間）を送信しなければならない。

10.2. 登録されていないメールアドレスでパスワードリセットをリクエストした場合、認証サービスはHTTP 200を返却しリセットメールを送信してはならない（メールアドレス存在有無の漏洩防止）。

10.3. 有効なリセットリンクで新パスワードを送信したとき、認証サービスはパスワードを更新し当該ユーザーのすべての既存セッションを無効化しなければならない。

10.4. 有効期限切れのリセットリンクが使用された場合、認証サービスはHTTP 410を返却しなければならない。

10.5. 既に使用済みのリセットリンクが使用された場合、認証サービスはHTTP 410を返却しなければならない。

---

### 要件 11: 住所帳管理

**目的:** 顧客として、配送先住所を事前に登録・管理できる機能を実現し、チェックアウト時の住所入力を省略できるようにしたい。

#### 受け入れ条件

11.1. 認証済み顧客が住所登録をリクエストしたとき、住所帳サービスは郵便番号・都道府県・市区町村・番地・氏名・電話番号がすべて入力されていることを検証しなければならない。

11.2. 必須住所項目が未入力の場合、住所帳サービスはHTTP 400と未入力の項目名一覧を返却しなければならない。

11.3. 認証済み顧客が住所一覧をリクエストしたとき、住所帳サービスはそのユーザーに紐づく全住所を返却しなければならない。

11.4. 認証済み顧客が住所更新をリクエストしたとき、住所帳サービスは指定住所IDの情報を更新しなければならない。

11.5. 認証済み顧客が住所削除をリクエストしたとき、住所帳サービスはその住所をユーザーの住所帳から除去しなければならない。

11.6. 他のユーザーが所有する住所IDに対して更新または削除をリクエストした場合、住所帳サービスはHTTP 403を返却しなければならない。

11.7. 住所帳の登録件数が10件の状態で追加をリクエストした場合、住所帳サービスはHTTP 400と `ADDRESS_BOOK_LIMIT_EXCEEDED` エラーコードを返却しなければならない。

---

### 要件 12: 注文履歴・注文詳細

**目的:** 顧客として、過去の注文を確認できる機能を実現し、購入した商品・金額・配送状況を把握できるようにしたい。

#### 受け入れ条件

12.1. 認証済み顧客が注文履歴をリクエストしたとき、注文サービスはそのユーザーの注文一覧を注文日降順で返却しなければならない。

12.2. 認証済み顧客が注文IDを指定して注文詳細をリクエストしたとき、注文サービスは注文番号・注文日時・商品名と数量の一覧・小計・送料・合計金額・配送先住所・注文ステータスを返却しなければならない。

12.3. 他のユーザーが所有する注文IDに対して詳細取得をリクエストした場合、注文サービスはHTTP 403を返却しなければならない。

12.4. 存在しない注文IDが指定された場合、注文サービスはHTTP 404を返却しなければならない。

---

### 要件 13: 管理者 - 商品CRUD

**目的:** 管理者として、商品を登録・編集・削除できる機能を実現し、販売商品カタログを最新の状態に維持したい。

#### 受け入れ条件

13.1. 管理者が商品登録をリクエストしたとき、商品管理サービスは商品名・商品説明・販売価格・カテゴリID・初期在庫数がすべて入力されていることを検証しなければならない。

13.2. 必須項目が未入力の場合、商品管理サービスはHTTP 400と未入力の項目名一覧を返却しなければならない。

13.3. 販売価格に0未満の値が指定された場合、商品管理サービスはHTTP 400と `INVALID_PRICE` エラーコードを返却しなければならない。

13.4. 管理者が商品情報の更新をリクエストしたとき、商品管理サービスは指定商品IDの情報を更新し `ProductUpdated` イベントを発行しなければならない。

13.5. 管理者が商品削除をリクエストしたとき、商品管理サービスはその商品を非公開状態（論理削除）に変更し `ProductDeleted` イベントを発行しなければならない。

13.6. 存在しない商品IDに対して更新または削除をリクエストした場合、商品管理サービスはHTTP 404を返却しなければならない。

13.7. 管理者ロールを持たないユーザーが商品管理APIにアクセスした場合、商品管理サービスはHTTP 403を返却しなければならない。

---

### 要件 14: 管理者 - 在庫数管理

**目的:** 管理者として、商品の在庫数を直接更新できる機能を実現し、実際の在庫状況をシステムに反映させたい。

#### 受け入れ条件

14.1. 管理者が商品IDと在庫数を指定して在庫更新をリクエストしたとき、在庫管理サービスは指定商品の在庫数を指定値に更新し `StockUpdated` イベントを発行しなければならない。

14.2. 在庫数に0未満の値が指定された場合、在庫管理サービスはHTTP 400と `INVALID_STOCK_COUNT` エラーコードを返却しなければならない。

14.3. 在庫数が0に設定された場合、在庫管理サービスは対象商品の在庫状況を `OUT_OF_STOCK` に更新しなければならない。

14.4. 存在しない商品IDに対して在庫更新をリクエストした場合、在庫管理サービスはHTTP 404を返却しなければならない。

---

### 要件 15: 管理者 - カテゴリ管理

**目的:** 管理者として、商品カテゴリを管理できる機能を実現し、顧客が商品を目的別に絞り込めるようにしたい。

#### 受け入れ条件

15.1. 管理者がカテゴリ名を指定してカテゴリ作成をリクエストしたとき、カテゴリ管理サービスはカテゴリ名（1文字以上100文字以内）が入力されていることを検証しなければならない。

15.2. 既存のカテゴリ名と重複するカテゴリ名でカテゴリ作成をリクエストした場合、カテゴリ管理サービスはHTTP 409と `CATEGORY_NAME_CONFLICT` エラーコードを返却しなければならない。

15.3. 管理者がカテゴリ一覧をリクエストしたとき、カテゴリ管理サービスは全カテゴリを返却しなければならない。

15.4. 管理者がカテゴリ削除をリクエストしたとき、対象カテゴリに商品が1件以上紐づいている場合、カテゴリ管理サービスはHTTP 409と `CATEGORY_HAS_PRODUCTS` エラーコードを返却しなければならない。

15.5. 対象カテゴリに商品が存在しない場合にカテゴリ削除をリクエストしたとき、カテゴリ管理サービスはそのカテゴリを削除しなければならない。

---

### 要件 16: 管理者 - 画像アップロード

**目的:** 管理者として、商品画像をアップロードして商品に関連付けられる機能を実現し、顧客に商品の外観を視覚的に伝えられるようにしたい。

#### 受け入れ条件

16.1. 管理者が画像ファイルをアップロードしたとき、画像管理サービスはファイルをCloudflare R2に保存し公開URLを返却しなければならない。

16.2. アップロードされたファイルの形式がJPEG・PNG・WebP以外の場合、画像管理サービスはHTTP 400と `UNSUPPORTED_IMAGE_FORMAT` エラーコードを返却しなければならない。

16.3. アップロードされたファイルサイズが10MBを超える場合、画像管理サービスはHTTP 413と `FILE_TOO_LARGE` エラーコードを返却しなければならない。

16.4. 管理者が商品IDと画像URLを指定して画像関連付けをリクエストしたとき、商品管理サービスはその商品の画像URL一覧に指定URLを追加しなければならない。

16.5. 対象商品に既に10枚の画像が関連付けられている状態で画像関連付けをリクエストした場合、商品管理サービスはHTTP 400と `PRODUCT_IMAGE_LIMIT_EXCEEDED` エラーコードを返却しなければならない。

---

### 要件 17: 管理者 - 注文一覧・ステータス管理

**目的:** 管理者として、全注文のステータスを管理できる機能を実現し、注文処理の進捗を正確に追跡・更新できるようにしたい。

#### 受け入れ条件

17.1. 管理者が注文一覧をリクエストしたとき、注文管理サービスは全ユーザーの注文一覧を注文日降順で返却しなければならない。

17.2. 管理者がステータスまたは日付範囲を指定して注文一覧をリクエストしたとき、注文管理サービスは指定条件に合致する注文のみを返却しなければならない。

17.3. 管理者が注文ステータスを `SHIPPED` に更新しようとしたとき、対象注文のステータスが `ACCEPTED` である場合にのみ、注文管理サービスはステータスを `SHIPPED` に更新し `OrderShipped` イベントを発行しなければならない。

17.4. 管理者が注文ステータスを `COMPLETED` に更新しようとしたとき、対象注文のステータスが `SHIPPED` である場合にのみ、注文管理サービスはステータスを `COMPLETED` に更新し `OrderCompleted` イベントを発行しなければならない。

17.5. ステータス遷移ルール（`ACCEPTED` → `SHIPPED` → `COMPLETED`）に反するステータス更新をリクエストした場合、注文管理サービスはHTTP 400と現在のステータス・遷移可能なステータスの一覧を返却しなければならない。

---

### 要件 18: 管理者 - キャンセル・返金処理

**目的:** 管理者として、注文のキャンセルと返金を処理できる機能を実現し、顧客への適切な対応を行えるようにしたい。

#### 受け入れ条件

18.1. 管理者が `ACCEPTED` または `SHIPPED` ステータスの注文に対してキャンセルをリクエストしたとき、注文管理サービスは注文ステータスを `CANCELLED` に更新し注文数量分の在庫を復元しなければならない。

18.2. `COMPLETED` ステータスの注文に対してキャンセルをリクエストした場合、注文管理サービスはHTTP 400と `ORDER_ALREADY_COMPLETED` エラーコードを返却しなければならない。

18.3. 管理者がクレジットカード決済済みの注文に対して返金処理をリクエストしたとき、決済サービスは外部決済プロバイダーに返金リクエストを送信しなければならない。

18.4. 返金が完了したとき、決済サービスは `RefundCompleted` イベントを発行し顧客の登録メールアドレスに返金完了通知メールを送信しなければならない。

18.5. コンビニ払い未入金の注文をキャンセルした場合、注文管理サービスは払込票番号を無効化しなければならない。

---

### 要件 19: 管理者 - 会員管理

**目的:** 管理者として、会員情報を確認できる機能を実現し、顧客対応を適切に行えるようにしたい。

#### 受け入れ条件

19.1. 管理者が会員一覧をリクエストしたとき、顧客管理サービスは全会員の会員ID・氏名・メールアドレス・登録日の一覧を返却しなければならない。

19.2. 管理者がキーワードを指定して会員検索をリクエストしたとき、顧客管理サービスは氏名またはメールアドレスにそのキーワードを含む会員のみを返却しなければならない。

19.3. 管理者が会員IDを指定して会員詳細をリクエストしたとき、顧客管理サービスは会員情報・注文履歴一覧・登録住所一覧を返却しなければならない。

19.4. 存在しない会員IDに対して会員詳細をリクエストした場合、顧客管理サービスはHTTP 404を返却しなければならない。

---

### 要件 20: セキュリティ

**目的:** システム管理者として、顧客データとシステムを保護できる機能を実現し、不正アクセスや情報漏洩を防止したい。

#### 受け入れ条件

20.1. 認証サービスは常にパスワードをbcrypt（コスト係数12以上）でハッシュ化して保存しなければならない。

20.2. 決済サービスは常にクレジットカード番号・CVVをアプリケーションログ・イベントストア・データベースに平文で記録してはならない。

20.3. 全APIエンドポイントは常にHTTPS接続のみを受け入れなければならない。

20.4. 管理者APIは常に管理者ロール（`ADMIN`）を持つユーザーのJWTトークンのみを認可しなければならない。

20.5. 改ざんされたJWTトークンを送信した場合、認証サービスはHTTP 401を返却しなければならない。

---

### 要件 21: パフォーマンス

**目的:** システム管理者として、サービスが規定のレスポンスタイム内で動作することを確認し、顧客体験を確保したい。

#### 受け入れ条件

21.1. 商品一覧APIは同時接続100リクエスト時においても、リクエスト受信から500ms以内にレスポンスを返却しなければならない。

21.2. 商品詳細APIは同時接続100リクエスト時においても、リクエスト受信から300ms以内にレスポンスを返却しなければならない。

21.3. 決済処理は開始から30秒以内に完了または `PAYMENT_TIMEOUT` エラーを返却しなければならない。

---

### 要件 22: Event Sourcingとデータ整合性

**目的:** システム管理者として、Event Sourcingパターンによりすべての状態変更を追跡可能にし、データの整合性と監査証跡を確保したい。

#### 受け入れ条件

22.1. 集約の状態変更が発生したとき、イベントストアはイベントタイプ・集約ID・バージョン番号・タイムスタンプ・イベントペイロードを含むイベントを永続化しなければならない。

22.2. 同一集約への並行書き込みが発生した場合、イベントストアは楽観的ロック（バージョン番号の不一致検出）によりコンフリクトを検出しHTTP 409と `VERSION_CONFLICT` エラーコードを返却しなければならない。

22.3. CQRSの読み取りモデル（クエリ側）はイベント処理から1秒以内に更新されなければならない。

22.4. イベントストアは常にイベントの追記のみを許可し、既存イベントの更新・削除を受け付けてはならない。

---

### 要件 23: メールアドレス確認

**目的:** 顧客として、登録したメールアドレスの所有を確認できる機能を実現し、アカウントのセキュリティを確保したい。

#### 受け入れ条件

23.1. 顧客がメールアドレス確認リンクに含まれるトークンを送信したとき、認証サービスはトークンの有効性を検証しアカウントのメール確認済みフラグを有効化しなければならない。

23.2. 有効期限切れのメールアドレス確認トークンが送信された場合、認証サービスはHTTP 410と `VERIFICATION_TOKEN_EXPIRED` エラーコードを返却しなければならない。

23.3. 既に使用済みのメールアドレス確認トークンが送信された場合、認証サービスはHTTP 410と `VERIFICATION_TOKEN_USED` エラーコードを返却しなければならない。

---

### 要件 24: ログアウト

**目的:** 顧客として、アカウントからログアウトできる機能を実現し、使用したデバイスでの不正アクセスを防止したい。

#### 受け入れ条件

24.1. 認証済みユーザーがログアウトをリクエストしたとき、認証サービスは現在使用中のリフレッシュトークンをデータストア上で無効化しなければならない。

24.2. 無効化されたリフレッシュトークンを使用してトークン更新をリクエストした場合、認証サービスはHTTP 401を返却しなければならない。

---

## 要件間の依存関係

| 要件 | 依存先 |
|------|-------|
| 3（ウィッシュリスト） | 8・9（認証） |
| 4（カート） | 2（商品詳細・在庫確認） |
| 5（チェックアウト） | 4（カート）・8・9（認証）・11（住所帳） |
| 6（決済） | 5（チェックアウト）・22（Event Sourcing） |
| 7（注文確認メール） | 6（決済完了イベント） |
| 10（パスワードリセット） | 8（会員登録） |
| 11（住所帳） | 8・9（認証） |
| 12（注文履歴） | 6（決済・注文確定）・8・9（認証） |
| 13（管理者商品CRUD） | 15（カテゴリ）・22（Event Sourcing） |
| 14（在庫管理） | 13（商品）・22（Event Sourcing） |
| 16（画像アップロード） | 13（商品）・Cloudflare R2 |
| 17（注文ステータス） | 6（決済・注文確定）・22（Event Sourcing） |
| 18（キャンセル・返金） | 17（注文ステータス）・6（決済）・14（在庫復元） |
| 19（会員管理） | 8・9（認証） |
| 22（Event Sourcing） | 全状態変更要件（6・13・14・17・18） |
| 23（メールアドレス確認） | 8（会員登録・確認メール送信） |
| 24（ログアウト） | 9（ログイン・トークン管理） |
